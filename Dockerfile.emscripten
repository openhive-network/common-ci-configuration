# syntax=docker/dockerfile:1.5
ARG EMSCRIPTEN_VERSION=3.1.62

FROM emscripten/emsdk:${EMSCRIPTEN_VERSION} AS pure_emscripten_sdk

FROM pure_emscripten_sdk AS supplemented_emscripten_sdk

ARG PNPM_VERSION=9.1.1
ENV PNPM_VERSION=9.1.1

USER root

RUN apt-get update && \
  DEBIAN_FRONTEND=noniteractive apt-get install -y \
    git \
    jq \
    ninja-build \
    autoconf \
    libtool \
    protobuf-compiler && \
    apt-get clean && rm -r /var/lib/apt/lists/*

FROM supplemented_emscripten_sdk AS supplemented_node_sdk

ARG NODEJS_VERSION=v18.19.0
ENV NODEJS_VERSION=${NODEJS_VERSION}

USER emscripten
WORKDIR /home/emscripten

ENV LANG=en_US.UTF-8
SHELL ["/bin/bash", "-c"]
ENV SHELL=/bin/bash
ENV HOME=/home/emscripten

# Preinstall large deps (rare changed) to eliminate pulling them from web each time
ENV PNPM_HOME="/home/emscripten/.local/share/pnpm"
ENV NVM_DIR="${HOME}/.nvm"
ENV PATH="${PNPM_HOME}:${NVM_DIR}:${PATH}"
ENV PLAYWRIGHT_BROWSERS_PATH="${HOME}/pw-browsers"

RUN source "${EMSDK}/emsdk_env.sh" && \
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash && \
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" && \
    nvm install "${NODEJS_VERSION}" && \
    nvm use "${NODEJS_VERSION}" && \
    corepack enable pnpm && \
    corepack install -g pnpm@9.1.1 && \
    pnpm config set store-dir ${PNPM_HOME}/preinstalled-store --global && \
    pnpm add  \
      playwright@~1.39.0 \
      @playwright/test@~1.39.0 \
      ts-proto@~1.158.0 \
      tslib@~2.6.2 \
      typescript@~5.2.2 \
      rollup@~4.3.0 \
      rollup/plugin-node-resolve@~15.2.3 \
      rollup/plugin-commonjs@~25.0.7 \
      rollup-plugin-typescript2@~0.36.0 \
      types/node@~20.10.6 \
      typedoc@~0.25.3 \
      typedoc-plugin-markdown@~3.17.1 \
      protobufjs@~7.2.5 && \
    pnpm playwright install chromium && \
    git config --global advice.detachedHead false && \
    git config --global --add safe.directory '*' && \
    chmod -c o+x "${HOME}" && \
    chmod -Rc o+r "${HOME}" && \
    chmod -c o+r "${HOME}/.bashrc"

USER root
WORKDIR /home/emscripten
ENV PNPM_HOME="/home/emscripten/.local/share/pnpm"
ENV PLAYWRIGHT_BROWSERS_PATH="${HOME}/pw-browsers"
ENV PATH="${PNPM_HOME}:${PATH}"

RUN [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" && \
  nvm use "${NODEJS_VERSION}" && \
  pnpm playwright install-deps && apt-get clean && rm -r /var/lib/apt/lists/*

USER emscripten
WORKDIR /home/emscripten

USER emscripten
WORKDIR /home/emscripten

FROM supplemented_emscripten_sdk AS lib_source

ARG BOOST_VERSION_TAG=boost-1.82.0
ENV BOOST_VERSION_TAG=${BOOST_VERSION_TAG}

ARG OPENSSL_VERSION_TAG=openssl-3.1.1
ENV OPENSSL_VERSION_TAG=${OPENSSL_VERSION_TAG}

USER emscripten
WORKDIR /home/emscripten

RUN <<-EOF
  set -e

  mkdir -vp tmp_src
  cd tmp_src

  git clone https://github.com/boostorg/boost.git

  cd boost
  git checkout tags/${BOOST_VERSION_TAG}
  git submodule update --init --recursive

  cd ..
  git clone https://github.com/openssl/openssl.git

  cd openssl
  git checkout tags/${OPENSSL_VERSION_TAG}
  git submodule update --init --recursive
  
  cd ..
  git clone https://github.com/ElementsProject/secp256k1-zkp.git
EOF

FROM lib_source as emscripten_lib_builder

USER emscripten
WORKDIR /home/emscripten

ENV TMP_SRC=/home/emscripten/tmp_src

ADD --chown=emscripten ./scripts/bash/emscripten /home/emscripten/scripts
RUN mkdir -vp "${TMP_SRC}"

FROM emscripten_lib_builder AS emscripten_boost_builder

USER emscripten
WORKDIR /home/emscripten

RUN /home/emscripten/scripts/prepare_boost.sh "${TMP_SRC}" "/emsdk/upstream/emscripten/cache/sysroot/"

FROM emscripten_lib_builder AS emscripten_openssl_builder

USER emscripten
WORKDIR /home/emscripten

RUN /home/emscripten/scripts/prepare_openssl.sh "${TMP_SRC}" "/emsdk/upstream/emscripten/cache/sysroot/"

FROM emscripten_lib_builder AS emscripten_secp256k1_builder

USER emscripten
WORKDIR /home/emscripten

RUN /home/emscripten/scripts/prepare_secp256k1-zkp.sh "${TMP_SRC}" "/emsdk/upstream/emscripten/cache/sysroot/"

FROM supplemented_node_sdk AS emscripten_builder

USER emscripten
WORKDIR /home/emscripten

COPY --chown=emscripten --from=emscripten_secp256k1_builder /emsdk/upstream/emscripten/cache/sysroot/ /emsdk/upstream/emscripten/cache/sysroot/
COPY --chown=emscripten --from=emscripten_boost_builder /emsdk/upstream/emscripten/cache/sysroot/ /emsdk/upstream/emscripten/cache/sysroot/
COPY --chown=emscripten --from=emscripten_openssl_builder /emsdk/upstream/emscripten/cache/sysroot/ /emsdk/upstream/emscripten/cache/sysroot/

COPY --chown=emscripten --from=emscripten_openssl_builder /emsdk/upstream/emscripten/cache/sysroot/libx32/ /emsdk/upstream/emscripten/cache/sysroot/lib/wasm32-emscripten/
COPY --chown=emscripten --from=emscripten_openssl_builder /emsdk/upstream/emscripten/cache/sysroot/libx32/pkgconfig/* /emsdk/upstream/emscripten/cache/sysroot/lib/pkgconfig/

FROM emscripten_builder AS supplemented_emscripten_builder

USER emscripten
WORKDIR /home/emscripten

ADD --chown=emscripten ./scripts/bash/npm-helpers /home/emscripten/scripts/
