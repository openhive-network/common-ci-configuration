include:
  - local: templates/base.gitlab-ci.yml

variables:
  # uses registry.gitlab.syncad.com/hive/common-ci-configuration/emsdk:b8325db3fb0b5d49ccf957b9e718d573265f164c@sha256:c5587bd4e05922c264cfdfb2aa8db5ad819667007d73d0149346ee95e6409193
  EMSCRIPTEN_IMAGE_TAG: "@sha256:c5587bd4e05922c264cfdfb2aa8db5ad819667007d73d0149346ee95e6409193"
  EMSCRIPTEN_IMAGE: "registry.gitlab.syncad.com/hive/common-ci-configuration/emsdk:3.1.47$EMSCRIPTEN_IMAGE_TAG"

.wasm_build_job_template:
  extends: .job-defaults
  variables:
    # The directory containing sources to be built - it should be overrided by derived job
    SOURCE_DIR: ""
    # Output directory where should be stored binaries - it should be overrided by derived job
    BINARIES_DIR: ""

  image: ${EMSCRIPTEN_IMAGE}

  before_script:
    - git config --global --add safe.directory '*'

  script:
    - mkdir -vp "${BINARIES_DIR}"
    - cd "${BINARIES_DIR}"
    - cmake -DBoost_NO_WARN_NEW_VERSIONS=1 -DBoost_USE_STATIC_RUNTIME=ON -DCMAKE_TOOLCHAIN_FILE=/emsdk/upstream/emscripten/cmake/Modules/Platform/Emscripten.cmake -DCMAKE_BUILD_TYPE=Release -G "Unix Makefiles" -S "${SOURCE_DIR}" -B "${BINARIES_DIR}"
    - make -j 8

  artifacts:
    paths:
      - "${BINARIES_DIR}/*.d.ts"
      - "${BINARIES_DIR}/*.mjs"
      - "${BINARIES_DIR}/*.js"
      - "${BINARIES_DIR}/*.wasm"
    when: always
    expire_in: 1 week
